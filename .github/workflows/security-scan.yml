name: Fix security vulnerabilities with AI

on:
  # Trigger on cron schedule (runs daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # Trigger on pull requests
  pull_request:
    branches:
      - main
  
  # Trigger when code is merged to main
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  security-events: write

jobs:
  vulnerability-detection:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    outputs:
      vulnerabilities-found: ${{ steps.extract_vulns.outputs.fixable_count }}
      has-vulnerabilities: ${{ steps.extract_vulns.outputs.fixable_count > 0 }}
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js (adjust version as needed for your project)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Install Snyk CLI
      - name: Install Snyk CLI
        run: npm install -g snyk

      # Step 5: Authenticate with Snyk
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # Step 6: Run Snyk vulnerability scan
      - name: Run Snyk vulnerability scan
        run: snyk test --json --severity-threshold=high > snyk-results.json || true

      # Step 7: Filter and display high-risk vulnerabilities
      - name: Extract high-risk vulnerabilities
        run: |
          echo "=== HIGH RISK VULNERABILITIES ==="
          snyk test --severity-threshold=high --json | jq '.vulnerabilities[] | select(.severity == "high" or .severity == "critical") | {title: .title, severity: .severity, package: .packageName, version: .version, identifiers: .identifiers}'

      # Step 8: Generate summary report of high-risk issues
      - name: Generate vulnerability summary
        run: |
          echo "## Snyk Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          HIGH_COUNT=$(snyk test --json 2>/dev/null | jq '[.vulnerabilities[] | select(.severity == "high")] | length' || echo "0")
          CRITICAL_COUNT=$(snyk test --json 2>/dev/null | jq '[.vulnerabilities[] | select(.severity == "critical")] | length' || echo "0")
          
          echo "**Critical Vulnerabilities:** $CRITICAL_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**High Vulnerabilities:** $HIGH_COUNT" >> $GITHUB_STEP_SUMMARY

      # Step 9: Parse and extract vulnerabilities for GitHub Copilot processing
      - name: Extract fixable vulnerabilities
        id: extract_vulns
        run: |
          # Create a detailed vulnerability report
          echo "Creating detailed vulnerability report..."
          snyk test --json > full-scan-results.json || true
          
          # Check if we have scan results
          if [ ! -f "full-scan-results.json" ] || [ ! -s "full-scan-results.json" ]; then
            echo "No scan results found, creating empty results"
            echo '{"vulnerabilities": []}' > full-scan-results.json
          fi
          
          # Debug: Show structure of scan results
          echo "Scan results structure:"
          jq -r 'keys' full-scan-results.json 2>/dev/null || echo "Invalid JSON in scan results"
          
          # Extract high and critical vulnerabilities with detailed context
          echo "Extracting vulnerabilities..."
          jq -c '.vulnerabilities[]? // [] | select(.severity == "high" or .severity == "critical") | {
            id: (.id // "unknown"),
            title: (.title // "Unknown Vulnerability"),
            severity: (.severity // "unknown"),
            packageName: (.packageName // "unknown"),
            version: (.version // "unknown"),
            nearestFixedInVersion: (.nearestFixedInVersion // null),
            isUpgradable: (.isUpgradable // false),
            isPatchable: (.isPatchable // false),
            upgradePath: (.upgradePath // []),
            description: (.description // "No description available"),
            references: (.references // []),
            CVSSv3: (.CVSSv3 // null),
            from: (.from // [])
          }' full-scan-results.json 2>/dev/null | jq -s '.' > detailed-vulnerabilities.json || echo "[]" > detailed-vulnerabilities.json
          
          # Count vulnerabilities
          VULN_COUNT=$(jq 'length' detailed-vulnerabilities.json 2>/dev/null | head -n 1 | tr -d '\n\r' || echo "0")
          # Debug: show raw count value
          echo "Raw VULN_COUNT value: '$VULN_COUNT'"
          # Ensure it's a valid number
          if ! [[ "$VULN_COUNT" =~ ^[0-9]+$ ]]; then
            echo "Invalid vulnerability count: '$VULN_COUNT', setting to 0"
            VULN_COUNT=0
          fi
          echo "fixable_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "Found $VULN_COUNT high/critical vulnerabilities"
          
          # Create context file for GitHub Copilot
          echo "# Security Vulnerability Analysis Report" > vulnerability-context.md
          echo "" >> vulnerability-context.md
          echo "**Project:** ${{ github.repository }}" >> vulnerability-context.md
          echo "**Scan Date:** $(date)" >> vulnerability-context.md
          echo "**Total High/Critical Vulnerabilities:** $VULN_COUNT" >> vulnerability-context.md
          echo "" >> vulnerability-context.md
          
          # Generate detailed vulnerability descriptions for Copilot
          echo "## Detected Vulnerabilities" >> vulnerability-context.md
          echo "" >> vulnerability-context.md
          
          if [ "$VULN_COUNT" -gt 0 ] 2>/dev/null; then
            echo "Processing $VULN_COUNT vulnerabilities..."
            jq -r '.[] | "### \(.title // "Unknown Vulnerability") (\(.severity // "unknown" | ascii_upcase))
            
            **Package:** \(.packageName // "unknown")@\(.version // "unknown")
            **CVE ID:** \(.id // "N/A")
            **CVSS Score:** \(.CVSSv3 // "N/A")
            **Current Version:** \(.version // "unknown")
            **Fixed In:** \(.nearestFixedInVersion // "No direct fix available")
            **Upgradable:** \(.isUpgradable // false)
            **Patchable:** \(.isPatchable // false)
            **Dependency Path:** \(if .from then (.from | if type == "array" then join(" ‚Üí ") else tostring end) else "Direct dependency" end)
            
            **Description:** \(.description // "No description available")
            
            **References:**
            \(if .references then 
              (if (.references | type) == "array" then 
                (.references | map("- \(.)") | join("\n")) 
              else 
                "- \(.references)" 
              end) 
            else 
              "No references available" 
            end)
            
            ---
            "' detailed-vulnerabilities.json >> vulnerability-context.md 2>/dev/null || echo "Error processing vulnerability details" >> vulnerability-context.md
          else
            echo "No high or critical vulnerabilities detected."
            echo "No high or critical vulnerabilities detected." >> vulnerability-context.md
            echo "" >> vulnerability-context.md
            echo "‚úÖ This project appears to be secure from high and critical vulnerabilities!" >> vulnerability-context.md
          fi

      # Step 10: Upload vulnerability data for fix job
      - name: Upload vulnerability artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-data
          path: |
            full-scan-results.json
            detailed-vulnerabilities.json
            vulnerability-context.md
            snyk-results.json

      # Debug step: Show what we found
      - name: Debug vulnerability detection
        if: always()
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo "Vulnerability files created:"
          ls -la *.json *.md 2>/dev/null || echo "No files found"
          echo ""
          echo "Detailed vulnerabilities content:"
          if [ -f detailed-vulnerabilities.json ]; then
            cat detailed-vulnerabilities.json | head -20
          else
            echo "detailed-vulnerabilities.json not found"
          fi
          echo ""
          echo "Vulnerability context preview:"
          if [ -f vulnerability-context.md ]; then
            head -20 vulnerability-context.md
          else
            echo "vulnerability-context.md not found"
          fi

  create-vulnerability-issues:
    runs-on: ubuntu-latest
    needs: vulnerability-detection
    if: needs.vulnerability-detection.outputs.has-vulnerabilities == 'true'
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Download vulnerability data
      - name: Download vulnerability data
        uses: actions/download-artifact@v4
        with:
          name: vulnerability-data
          path: vulnerability-data/

      # Step 3: Set up GitHub CLI authentication
      - name: Set up GitHub CLI authentication
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status

      # Step 4: Create GitHub issues for each vulnerability
      - name: Create GitHub issues for vulnerabilities
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üêõ Creating GitHub issues for discovered vulnerabilities..."
          
          # Create labels if they don't exist
          echo "Creating repository labels..."
          gh label create "security" --description "Security vulnerability" --color "d73a4a" --force || echo "Security label exists"
          gh label create "vulnerability" --description "Security vulnerability found by scan" --color "b60205" --force || echo "Vulnerability label exists"
          gh label create "high-priority" --description "High priority issue" --color "ff6b6b" --force || echo "High-priority label exists"
          gh label create "critical" --description "Critical severity issue" --color "d10000" --force || echo "Critical label exists"
          gh label create "ai-fix-requested" --description "AI assistance requested for fix" --color "0052cc" --force || echo "AI-fix-requested label exists"
          gh label create "copilot-task" --description "Task assigned to GitHub Copilot" --color "0366d6" --force || echo "Copilot-task label exists"
          gh label create "scheduled" --description "Automatically scheduled task" --color "7057ff" --force || echo "Scheduled label exists"
          
          # Check if vulnerabilities file exists and has content
          if [ ! -f "vulnerability-data/detailed-vulnerabilities.json" ]; then
            echo "‚ùå No vulnerability data file found"
            exit 1
          fi
          
          # Count vulnerabilities
          VULN_COUNT=$(jq 'length' vulnerability-data/detailed-vulnerabilities.json 2>/dev/null || echo "0")
          echo "Found $VULN_COUNT vulnerabilities to process"
          
          if [ "$VULN_COUNT" -eq 0 ]; then
            echo "No vulnerabilities to create issues for"
            exit 0
          fi
          
          # Create a tracking file for issue numbers
          echo "# Vulnerability Issues Created" > vulnerability-issues.md
          echo "" >> vulnerability-issues.md
          echo "Created on: $(date)" >> vulnerability-issues.md
          echo "Total vulnerabilities: $VULN_COUNT" >> vulnerability-issues.md
          echo "" >> vulnerability-issues.md
          
          # Process each vulnerability and create an issue
          jq -c '.[]' vulnerability-data/detailed-vulnerabilities.json | while IFS= read -r vuln; do
            # Extract vulnerability details
            VULN_ID=$(echo "$vuln" | jq -r '.id // "unknown"')
            VULN_TITLE=$(echo "$vuln" | jq -r '.title // "Unknown Vulnerability"')
            SEVERITY=$(echo "$vuln" | jq -r '.severity // "unknown"' | tr '[:lower:]' '[:upper:]')
            PACKAGE_NAME=$(echo "$vuln" | jq -r '.packageName // "unknown"')
            VERSION=$(echo "$vuln" | jq -r '.version // "unknown"')
            FIXED_VERSION=$(echo "$vuln" | jq -r '.nearestFixedInVersion // "No direct fix available"')
            DESCRIPTION=$(echo "$vuln" | jq -r '.description // "No description available"')
            IS_UPGRADABLE=$(echo "$vuln" | jq -r '.isUpgradable // false')
            IS_PATCHABLE=$(echo "$vuln" | jq -r '.isPatchable // false')
            CVSS_SCORE=$(echo "$vuln" | jq -r '.CVSSv3 // "N/A"')
            REFERENCES=$(echo "$vuln" | jq -r '.references[]? // "No references available"' | head -3 | paste -sd '\n')
            DEPENDENCY_PATH=$(echo "$vuln" | jq -r 'if .from then (.from | if type == "array" then join(" ‚Üí ") else tostring end) else "Direct dependency" end')
            
            # Create issue title
            ISSUE_TITLE="üîê [$SEVERITY] $VULN_TITLE in $PACKAGE_NAME@$VERSION"
            
            # Create issue body using printf to avoid YAML issues
            printf "## üö® Security Vulnerability Detected\n\n" > issue_body.md
            printf "**Vulnerability ID:** %s\n" "$VULN_ID" >> issue_body.md
            printf "**Severity:** %s\n" "$SEVERITY" >> issue_body.md
            printf "**CVSS Score:** %s\n" "$CVSS_SCORE" >> issue_body.md
            printf "**Package:** \`%s@%s\`\n" "$PACKAGE_NAME" "$VERSION" >> issue_body.md
            printf "**Fixed in Version:** \`%s\`\n" "$FIXED_VERSION" >> issue_body.md
            printf "**Dependency Path:** %s\n\n" "$DEPENDENCY_PATH" >> issue_body.md
            printf "### üìù Description\n%s\n\n" "$DESCRIPTION" >> issue_body.md
            printf "### üîß Fix Information\n" >> issue_body.md
            printf -- "- **Upgradable:** %s\n" "$IS_UPGRADABLE" >> issue_body.md
            printf -- "- **Patchable:** %s\n" "$IS_PATCHABLE" >> issue_body.md
            if [ "$FIXED_VERSION" != "No direct fix available" ]; then
              printf -- "- **Recommended Fix:** Update to version %s\n\n" "$FIXED_VERSION" >> issue_body.md
            else
              printf -- "- **Recommended Fix:** Review alternatives or apply manual patches\n\n" >> issue_body.md
            fi
            printf "### üìö References\n" >> issue_body.md
            if [ -n "$REFERENCES" ] && [ "$REFERENCES" != "No references available" ]; then
              printf "%s\n\n" "$REFERENCES" >> issue_body.md
            else
              printf "No references available\n\n" >> issue_body.md
            fi
            printf "### ü§ñ AI Fix Request\n" >> issue_body.md
            printf "@github-copilot please help fix this %s severity vulnerability in %s.\n\n" "$SEVERITY" "$PACKAGE_NAME" >> issue_body.md
            printf "**Specific requests:**\n" >> issue_body.md
            printf "1. Analyze the vulnerability and its impact on our codebase\n" >> issue_body.md
            printf "2. Suggest the safest way to update from \`%s\` to a secure version\n" "$VERSION" >> issue_body.md
            printf "3. Check for any breaking changes in the upgrade path\n" >> issue_body.md
            printf "4. Provide specific npm/yarn commands to apply the fix\n" >> issue_body.md
            printf "5. Suggest alternative packages if direct update isn't possible\n" >> issue_body.md
            printf "6. Review our usage of this package for any security best practices\n\n" >> issue_body.md
            printf "**Priority:** This is a %s severity issue that should be addressed promptly.\n\n" "$SEVERITY" >> issue_body.md
            printf "*This issue was automatically created by the AI Security Scan workflow on %s*\n" "$(date)" >> issue_body.md
            printf "*Scan run: %s*\n" "${{ github.run_id }}" >> issue_body.md
            
            # Determine labels based on severity
            LABELS="security,vulnerability,ai-fix-requested,copilot-task,scheduled"
            case "$SEVERITY" in
              "CRITICAL")
                LABELS="$LABELS,critical,high-priority"
                ;;
              "HIGH")
                LABELS="$LABELS,high-priority"
                ;;
            esac
            
            echo "Creating issue for: $VULN_TITLE ($SEVERITY)"
            
            # Create the GitHub issue
            if ISSUE_URL=$(gh issue create \
              --title "$ISSUE_TITLE" \
              --body-file issue_body.md \
              --label "$LABELS" \
              2>/dev/null); then
              
              echo "‚úÖ Created issue: $ISSUE_URL"
              
              # Extract issue number from URL
              ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
              
              # Assign issue to GitHub Copilot SWE agent using GraphQL
              echo "ü§ñ Attempting to assign issue #$ISSUE_NUMBER to GitHub Copilot..."
              
              # Create GraphQL query to find Copilot SWE agent
              FIND_COPILOT_QUERY='{
                "query": "query($owner: String!, $repo: String!) { repository(owner: $owner, name: $repo) { suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) { nodes { login __typename ... on Bot { id } ... on User { id } } } } }",
                "variables": {
                  "owner": "${{ github.repository_owner }}",
                  "repo": "${{ github.event.repository.name }}"
                }
              }'
              
              # Execute GraphQL query to find Copilot
              COPILOT_RESPONSE=$(gh api graphql --input - <<< "$FIND_COPILOT_QUERY" 2>/dev/null || echo "")
              
              if [ -n "$COPILOT_RESPONSE" ]; then
                # Extract Copilot actor ID
                COPILOT_ID=$(echo "$COPILOT_RESPONSE" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id' 2>/dev/null || echo "")
                
                if [ -n "$COPILOT_ID" ] && [ "$COPILOT_ID" != "null" ]; then
                  echo "‚úÖ Found Copilot SWE agent with ID: $COPILOT_ID"
                  
                  # Get issue GraphQL ID
                  GET_ISSUE_QUERY='{
                    "query": "query($owner: String!, $repo: String!, $issueNumber: Int!) { repository(owner: $owner, name: $repo) { issue(number: $issueNumber) { id } } }",
                    "variables": {
                      "owner": "${{ github.repository_owner }}",
                      "repo": "${{ github.event.repository.name }}",
                      "issueNumber": '$ISSUE_NUMBER'
                    }
                  }'
                  
                  ISSUE_RESPONSE=$(gh api graphql --input - <<< "$GET_ISSUE_QUERY" 2>/dev/null || echo "")
                  ISSUE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.data.repository.issue.id' 2>/dev/null || echo "")
                  
                  if [ -n "$ISSUE_ID" ] && [ "$ISSUE_ID" != "null" ]; then
                    # Assign issue to Copilot using GraphQL mutation
                    ASSIGN_MUTATION='{
                      "query": "mutation($issueId: ID!, $actorId: ID!) { replaceActorsForAssignable(input: {assignableId: $issueId, actorIds: [$actorId]}) { assignable { ... on Issue { id title assignees(first: 10) { nodes { login } } } } } }",
                      "variables": {
                        "issueId": "'$ISSUE_ID'",
                        "actorId": "'$COPILOT_ID'"
                      }
                    }'
                    
                    ASSIGN_RESPONSE=$(gh api graphql --input - <<< "$ASSIGN_MUTATION" 2>/dev/null || echo "")
                    
                    if [ -n "$ASSIGN_RESPONSE" ]; then
                      ASSIGNEES=$(echo "$ASSIGN_RESPONSE" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
                      echo "‚úÖ Successfully assigned issue #$ISSUE_NUMBER to Copilot"
                      echo "Assignees: $ASSIGNEES"
                    else
                      echo "‚ö†Ô∏è Failed to assign issue to Copilot (mutation failed)"
                    fi
                  else
                    echo "‚ö†Ô∏è Failed to get issue GraphQL ID"
                  fi
                else
                  echo "‚ö†Ô∏è Copilot SWE agent not found in repository suggested actors"
                  echo "Note: GitHub Copilot may not be enabled for this repository"
                fi
              else
                echo "‚ö†Ô∏è Failed to query repository suggested actors"
              fi
              
              # Add to tracking file
              echo "- [$SEVERITY] Issue #$ISSUE_NUMBER: $VULN_TITLE ($PACKAGE_NAME@$VERSION)" >> vulnerability-issues.md
              echo "  - URL: $ISSUE_URL" >> vulnerability-issues.md
              echo "  - CVE: $VULN_ID" >> vulnerability-issues.md
              echo "" >> vulnerability-issues.md
              
              # Create comment body for Copilot assistance using printf
              printf "## ü§ñ GitHub Copilot Fix Request\n\n" > copilot_comment.md
              printf "@github-copilot this %s severity vulnerability needs immediate attention:\n\n" "$SEVERITY" >> copilot_comment.md
              printf "**Package:** \`%s@%s\`\n" "$PACKAGE_NAME" "$VERSION" >> copilot_comment.md
              printf "**CVE:** %s\n" "$VULN_ID" >> copilot_comment.md
              if [ "$IS_UPGRADABLE" = "true" ]; then
                printf "**Current Status:** Upgradable to %s\n\n" "$FIXED_VERSION" >> copilot_comment.md
              else
                printf "**Current Status:** No direct upgrade path available\n\n" >> copilot_comment.md
              fi
              printf "**Please provide:**\n" >> copilot_comment.md
              printf "1. **Update command:** Specific npm/yarn command to fix this vulnerability\n" >> copilot_comment.md
              printf "2. **Compatibility check:** Will this update break existing functionality?\n" >> copilot_comment.md
              printf "3. **Alternative solutions:** If direct update isn't safe, what are the alternatives?\n" >> copilot_comment.md
              printf "4. **Code changes:** Any additional code changes needed after the update?\n" >> copilot_comment.md
              printf "5. **Testing recommendations:** How should we verify the fix doesn't break anything?\n\n" >> copilot_comment.md
              printf "**Example response format requested:**\n" >> copilot_comment.md
              printf "\`\`\`bash\n" >> copilot_comment.md
              printf "# Fix command\n" >> copilot_comment.md
              printf "npm update %s\n\n" "$PACKAGE_NAME" >> copilot_comment.md
              printf "# Or if specific version needed\n" >> copilot_comment.md
              printf "npm install %s@%s\n" "$PACKAGE_NAME" "$FIXED_VERSION" >> copilot_comment.md
              printf "\`\`\`\n\n" >> copilot_comment.md
              printf "**Urgency:** %s - Please prioritize this issue.\n\n" "$SEVERITY" >> copilot_comment.md
              printf "*Automated Copilot assistance request from security scan workflow*\n" >> copilot_comment.md
              
              # Add the Copilot assistance comment
              if gh issue comment "$ISSUE_NUMBER" --body-file copilot_comment.md 2>/dev/null; then
                echo "‚úÖ Added Copilot assistance comment to issue #$ISSUE_NUMBER"
              else
                echo "‚ö†Ô∏è Failed to add Copilot comment to issue #$ISSUE_NUMBER"
              fi
              
            else
              echo "‚ùå Failed to create issue for: $VULN_TITLE"
              echo "- [$SEVERITY] FAILED: $VULN_TITLE ($PACKAGE_NAME@$VERSION)" >> vulnerability-issues.md
            fi
            
            # Add a small delay to avoid rate limiting
            sleep 2
          done
          
          echo "Finished creating vulnerability issues"

      # Step 5: Create master tracking issue
      - name: Create master tracking issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìã Creating master tracking issue..."
          
          VULN_COUNT=$(jq 'length' vulnerability-data/detailed-vulnerabilities.json 2>/dev/null || echo "0")
          
          # Create comprehensive tracking issue
          TRACKING_TITLE="üîê Security Vulnerability Tracking - $(date +%Y-%m-%d) ($VULN_COUNT issues)"
          
          # Create tracking issue body using printf
          printf "## üö® Security Vulnerability Dashboard\n\n" > tracking_body.md
          printf "**Scan Date:** %s\n" "$(date)" >> tracking_body.md
          printf "**Total Vulnerabilities Found:** %s\n" "$VULN_COUNT" >> tracking_body.md
          printf "**Workflow Run:** [%s](%s/%s/actions/runs/%s)\n\n" "${{ github.run_id }}" "${{ github.server_url }}" "${{ github.repository }}" "${{ github.run_id }}" >> tracking_body.md
          
          printf "### üìä Vulnerability Summary\n" >> tracking_body.md
          if [ -f vulnerability-issues.md ]; then
            tail -n +5 vulnerability-issues.md >> tracking_body.md 2>/dev/null || printf "No vulnerability details available\n" >> tracking_body.md
          else
            printf "No vulnerability details available\n" >> tracking_body.md
          fi
          printf "\n" >> tracking_body.md
          
          printf "### üéØ Action Items\n" >> tracking_body.md
          printf -- "- [ ] Review all created vulnerability issues\n" >> tracking_body.md
          printf -- "- [ ] Prioritize critical and high severity vulnerabilities\n" >> tracking_body.md
          printf -- "- [ ] Apply fixes suggested by GitHub Copilot\n" >> tracking_body.md
          printf -- "- [ ] Test fixes in development environment\n" >> tracking_body.md
          printf -- "- [ ] Deploy fixes to production\n" >> tracking_body.md
          printf -- "- [ ] Close resolved vulnerability issues\n\n" >> tracking_body.md
          
          printf "### ü§ñ AI Assistance\n" >> tracking_body.md
          printf "All individual vulnerability issues have been tagged with \`ai-fix-requested\` and include specific requests for GitHub Copilot assistance. Each issue contains:\n" >> tracking_body.md
          printf -- "- Detailed vulnerability analysis\n" >> tracking_body.md
          printf -- "- Copilot fix requests with specific questions\n" >> tracking_body.md
          printf -- "- Upgrade path recommendations\n" >> tracking_body.md
          printf -- "- Alternative solution suggestions\n\n" >> tracking_body.md
          
          printf "### üìà Progress Tracking\n" >> tracking_body.md
          printf "Use this issue to track the overall progress of fixing the %s vulnerabilities detected in this scan.\n\n" "$VULN_COUNT" >> tracking_body.md
          
          printf "**Next Steps:**\n" >> tracking_body.md
          printf "1. Review individual vulnerability issues created by this workflow\n" >> tracking_body.md
          printf "2. Follow Copilot suggestions for each vulnerability\n" >> tracking_body.md
          printf "3. Test and apply fixes systematically\n" >> tracking_body.md
          printf "4. Update this tracking issue with progress\n\n" >> tracking_body.md
          
          printf "*This tracking issue was automatically created by the AI Security Scan workflow*\n" >> tracking_body.md
          printf "*For detailed vulnerability information, check the individual issues linked above*\n" >> tracking_body.md
          
          # Create the tracking issue
          if TRACKING_URL=$(gh issue create \
            --title "$TRACKING_TITLE" \
            --body-file tracking_body.md \
            --label "security,vulnerability,tracking,ai-fix-requested,copilot-task,scheduled" \
            2>/dev/null); then
            
            echo "‚úÖ Created tracking issue: $TRACKING_URL"
            TRACKING_NUMBER=$(echo "$TRACKING_URL" | grep -o '[0-9]*$')
            
            # Assign tracking issue to GitHub Copilot SWE agent using GraphQL
            echo "ü§ñ Attempting to assign tracking issue #$TRACKING_NUMBER to GitHub Copilot..."
            
            # Create GraphQL query to find Copilot SWE agent
            FIND_COPILOT_QUERY='{
              "query": "query($owner: String!, $repo: String!) { repository(owner: $owner, name: $repo) { suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) { nodes { login __typename ... on Bot { id } ... on User { id } } } } }",
              "variables": {
                "owner": "${{ github.repository_owner }}",
                "repo": "${{ github.event.repository.name }}"
              }
            }'
            
            # Execute GraphQL query to find Copilot
            COPILOT_RESPONSE=$(gh api graphql --input - <<< "$FIND_COPILOT_QUERY" 2>/dev/null || echo "")
            
            if [ -n "$COPILOT_RESPONSE" ]; then
              # Extract Copilot actor ID
              COPILOT_ID=$(echo "$COPILOT_RESPONSE" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id' 2>/dev/null || echo "")
              
              if [ -n "$COPILOT_ID" ] && [ "$COPILOT_ID" != "null" ]; then
                echo "‚úÖ Found Copilot SWE agent with ID: $COPILOT_ID"
                
                # Get tracking issue GraphQL ID
                GET_ISSUE_QUERY='{
                  "query": "query($owner: String!, $repo: String!, $issueNumber: Int!) { repository(owner: $owner, name: $repo) { issue(number: $issueNumber) { id } } }",
                  "variables": {
                    "owner": "${{ github.repository_owner }}",
                    "repo": "${{ github.event.repository.name }}",
                    "issueNumber": '$TRACKING_NUMBER'
                  }
                }'
                
                ISSUE_RESPONSE=$(gh api graphql --input - <<< "$GET_ISSUE_QUERY" 2>/dev/null || echo "")
                ISSUE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.data.repository.issue.id' 2>/dev/null || echo "")
                
                if [ -n "$ISSUE_ID" ] && [ "$ISSUE_ID" != "null" ]; then
                  # Assign tracking issue to Copilot using GraphQL mutation
                  ASSIGN_MUTATION='{
                    "query": "mutation($issueId: ID!, $actorId: ID!) { replaceActorsForAssignable(input: {assignableId: $issueId, actorIds: [$actorId]}) { assignable { ... on Issue { id title assignees(first: 10) { nodes { login } } } } } }",
                    "variables": {
                      "issueId": "'$ISSUE_ID'",
                      "actorId": "'$COPILOT_ID'"
                    }
                  }'
                  
                  ASSIGN_RESPONSE=$(gh api graphql --input - <<< "$ASSIGN_MUTATION" 2>/dev/null || echo "")
                  
                  if [ -n "$ASSIGN_RESPONSE" ]; then
                    ASSIGNEES=$(echo "$ASSIGN_RESPONSE" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
                    echo "‚úÖ Successfully assigned tracking issue #$TRACKING_NUMBER to Copilot"
                    echo "Assignees: $ASSIGNEES"
                  else
                    echo "‚ö†Ô∏è Failed to assign tracking issue to Copilot (mutation failed)"
                  fi
                else
                  echo "‚ö†Ô∏è Failed to get tracking issue GraphQL ID"
                fi
              else
                echo "‚ö†Ô∏è Copilot SWE agent not found in repository suggested actors"
                echo "Note: GitHub Copilot may not be enabled for this repository"
              fi
            else
              echo "‚ö†Ô∏è Failed to query repository suggested actors"
            fi
            
            # Pin the tracking issue if possible
            gh issue pin "$TRACKING_NUMBER" 2>/dev/null || echo "‚ö†Ô∏è Could not pin tracking issue (may not have permissions)"
            
            # Add Copilot coordination comment to tracking issue
            printf "## ü§ñ GitHub Copilot Coordination Request\n\n" > tracking_copilot_comment.md
            printf "@github-copilot please coordinate the resolution of %s security vulnerabilities detected in this scan:\n\n" "$VULN_COUNT" >> tracking_copilot_comment.md
            printf "**Master Coordination Tasks:**\n" >> tracking_copilot_comment.md
            printf "1. **Priority Assessment:** Review all %s vulnerability issues and recommend fixing order\n" "$VULN_COUNT" >> tracking_copilot_comment.md
            printf "2. **Dependency Analysis:** Check for conflicts between vulnerability fixes\n" >> tracking_copilot_comment.md
            printf "3. **Batch Processing:** Suggest which vulnerabilities can be fixed together safely\n" >> tracking_copilot_comment.md
            printf "4. **Risk Assessment:** Identify which fixes have highest impact vs. risk\n" >> tracking_copilot_comment.md
            printf "5. **Testing Strategy:** Recommend comprehensive testing approach for all fixes\n\n" >> tracking_copilot_comment.md
            printf "**Individual Issue Actions:**\n" >> tracking_copilot_comment.md
            printf "- Each vulnerability has its own issue with specific fix requests\n" >> tracking_copilot_comment.md
            printf "- All issues are labeled with \`copilot-task\` for your attention\n" >> tracking_copilot_comment.md
            printf "- Please provide specific npm/yarn commands for each vulnerability\n" >> tracking_copilot_comment.md
            printf "- Include compatibility and breaking change analysis\n\n" >> tracking_copilot_comment.md
            printf "**Expected Deliverables:**\n" >> tracking_copilot_comment.md
            printf "1. **Fix Priority Matrix:** Order of vulnerability resolution\n" >> tracking_copilot_comment.md
            printf "2. **Batch Fix Commands:** Grouped update commands where safe\n" >> tracking_copilot_comment.md
            printf "3. **Testing Checklist:** What to verify after each fix\n" >> tracking_copilot_comment.md
            printf "4. **Rollback Plan:** How to revert if fixes cause issues\n\n" >> tracking_copilot_comment.md
            printf "**Scan Details:**\n" >> tracking_copilot_comment.md
            printf "- **Workflow Run:** [%s](%s/%s/actions/runs/%s)\n" "${{ github.run_id }}" "${{ github.server_url }}" "${{ github.repository }}" "${{ github.run_id }}" >> tracking_copilot_comment.md
            printf "- **Scan Date:** %s\n" "$(date)" >> tracking_copilot_comment.md
            printf "- **Repository:** %s\n\n" "${{ github.repository }}" >> tracking_copilot_comment.md
            printf "Please coordinate responses across all vulnerability issues and provide an overall fix strategy here.\n\n" >> tracking_copilot_comment.md
            printf "*This is an automated coordination request from the AI Security Scan workflow*\n" >> tracking_copilot_comment.md
            
            # Add the Copilot coordination comment
            if gh issue comment "$TRACKING_NUMBER" --body-file tracking_copilot_comment.md 2>/dev/null; then
              echo "‚úÖ Added Copilot coordination comment to tracking issue #$TRACKING_NUMBER"
            else
              echo "‚ö†Ô∏è Failed to add Copilot coordination comment to tracking issue #$TRACKING_NUMBER"
            fi
            
          else
            echo "‚ùå Failed to create tracking issue"
          fi

      # Step 7: Create consolidated vulnerability report issue
      - name: Create consolidated vulnerability report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìã Creating consolidated vulnerability report issue..."
          
          VULN_COUNT=$(jq 'length' vulnerability-data/detailed-vulnerabilities.json 2>/dev/null || echo "0")
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            # Create comprehensive vulnerability report for Copilot
            printf "# Security Vulnerability Analysis Report\n\n" > vulnerability_report.md
            printf "**Repository:** %s\n" "${{ github.repository }}" >> vulnerability_report.md
            printf "**Scan Date:** %s\n" "$(date)" >> vulnerability_report.md
            printf "**Workflow Run:** [%s](%s/%s/actions/runs/%s)\n" "${{ github.run_id }}" "${{ github.server_url }}" "${{ github.repository }}" "${{ github.run_id }}" >> vulnerability_report.md
            printf "**Total Vulnerabilities:** %s\n\n" "$VULN_COUNT" >> vulnerability_report.md
            
            # Add detailed vulnerability information
            printf "## üîç Detected Vulnerabilities\n\n" >> vulnerability_report.md
            
            # Process each vulnerability individually to avoid YAML issues
            jq -c '.[]' vulnerability-data/detailed-vulnerabilities.json | while IFS= read -r vuln; do
              VULN_TITLE=$(echo "$vuln" | jq -r '.title // "Unknown Vulnerability"')
              SEVERITY=$(echo "$vuln" | jq -r '.severity // "unknown"' | tr '[:lower:]' '[:upper:]')
              PACKAGE_NAME=$(echo "$vuln" | jq -r '.packageName // "unknown"')
              VERSION=$(echo "$vuln" | jq -r '.version // "unknown"')
              VULN_ID=$(echo "$vuln" | jq -r '.id // "N/A"')
              CVSS_SCORE=$(echo "$vuln" | jq -r '.CVSSv3 // "N/A"')
              FIXED_VERSION=$(echo "$vuln" | jq -r '.nearestFixedInVersion // "No direct fix available"')
              IS_UPGRADABLE=$(echo "$vuln" | jq -r '.isUpgradable // false')
              IS_PATCHABLE=$(echo "$vuln" | jq -r '.isPatchable // false')
              DESCRIPTION=$(echo "$vuln" | jq -r '.description // "No description available"')
              DEPENDENCY_PATH=$(echo "$vuln" | jq -r 'if .from then (.from | if type == "array" then join(" ‚Üí ") else tostring end) else "Direct dependency" end')
              
              printf "### %s (%s)\n\n" "$VULN_TITLE" "$SEVERITY" >> vulnerability_report.md
              printf "**Package:** \`%s@%s\`\n" "$PACKAGE_NAME" "$VERSION" >> vulnerability_report.md
              printf "**CVE ID:** %s\n" "$VULN_ID" >> vulnerability_report.md
              printf "**CVSS Score:** %s\n" "$CVSS_SCORE" >> vulnerability_report.md
              printf "**Fixed In:** \`%s\`\n" "$FIXED_VERSION" >> vulnerability_report.md
              printf "**Upgradable:** %s\n" "$IS_UPGRADABLE" >> vulnerability_report.md
              printf "**Patchable:** %s\n" "$IS_PATCHABLE" >> vulnerability_report.md
              printf "**Dependency Path:** %s\n\n" "$DEPENDENCY_PATH" >> vulnerability_report.md
              printf "**Description:** %s\n\n" "$DESCRIPTION" >> vulnerability_report.md
              printf "**Fix Command Needed:**\n" >> vulnerability_report.md
              printf "\`\`\`bash\n" >> vulnerability_report.md
              printf "# Please provide specific npm/yarn command to fix this vulnerability\n" >> vulnerability_report.md
              printf "npm update %s\n" "$PACKAGE_NAME" >> vulnerability_report.md
              printf "# Or alternative fix approach\n" >> vulnerability_report.md
              printf "\`\`\`\n\n" >> vulnerability_report.md
              printf -- "---\n\n" >> vulnerability_report.md
            done
            
            # Create the consolidated issue using GitHub CLI (simpler approach)
            ISSUE_TITLE="Vulnerability Scan Update - $(date +%Y-%m-%d)"
            
            # Create issue with proper labeling
            if CONSOLIDATED_URL=$(gh issue create \
              --title "$ISSUE_TITLE" \
              --body-file vulnerability_report.md \
              --label "copilot-task,scheduled,vulnerability-scan,security,ai-fix-requested,high-priority" \
              2>/dev/null); then
              
              echo "‚úÖ Created consolidated issue: $CONSOLIDATED_URL"
              CONSOLIDATED_NUMBER=$(echo "$CONSOLIDATED_URL" | grep -o '[0-9]*$')
              
              # Assign to GitHub Copilot using the same GraphQL approach
              echo "ü§ñ Attempting to assign consolidated issue #$CONSOLIDATED_NUMBER to GitHub Copilot..."
              
              # Create GraphQL query to find Copilot SWE agent
              FIND_COPILOT_QUERY='{
                "query": "query($owner: String!, $repo: String!) { repository(owner: $owner, name: $repo) { suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) { nodes { login __typename ... on Bot { id } ... on User { id } } } } }",
                "variables": {
                  "owner": "${{ github.repository_owner }}",
                  "repo": "${{ github.event.repository.name }}"
                }
              }'
              
              # Execute GraphQL query to find Copilot
              COPILOT_RESPONSE=$(gh api graphql --input - <<< "$FIND_COPILOT_QUERY" 2>/dev/null || echo "")
              
              if [ -n "$COPILOT_RESPONSE" ]; then
                # Extract Copilot actor ID
                COPILOT_ID=$(echo "$COPILOT_RESPONSE" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id' 2>/dev/null || echo "")
                
                if [ -n "$COPILOT_ID" ] && [ "$COPILOT_ID" != "null" ]; then
                  echo "‚úÖ Found Copilot SWE agent with ID: $COPILOT_ID"
                  
                  # Get issue GraphQL ID
                  GET_ISSUE_QUERY='{
                    "query": "query($owner: String!, $repo: String!, $issueNumber: Int!) { repository(owner: $owner, name: $repo) { issue(number: $issueNumber) { id } } }",
                    "variables": {
                      "owner": "${{ github.repository_owner }}",
                      "repo": "${{ github.event.repository.name }}",
                      "issueNumber": '$CONSOLIDATED_NUMBER'
                    }
                  }'
                  
                  ISSUE_RESPONSE=$(gh api graphql --input - <<< "$GET_ISSUE_QUERY" 2>/dev/null || echo "")
                  ISSUE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.data.repository.issue.id' 2>/dev/null || echo "")
                  
                  if [ -n "$ISSUE_ID" ] && [ "$ISSUE_ID" != "null" ]; then
                    # Assign issue to Copilot using GraphQL mutation
                    ASSIGN_MUTATION='{
                      "query": "mutation($issueId: ID!, $actorId: ID!) { replaceActorsForAssignable(input: {assignableId: $issueId, actorIds: [$actorId]}) { assignable { ... on Issue { id title assignees(first: 10) { nodes { login } } } } } }",
                      "variables": {
                        "issueId": "'$ISSUE_ID'",
                        "actorId": "'$COPILOT_ID'"
                      }
                    }'
                    
                    ASSIGN_RESPONSE=$(gh api graphql --input - <<< "$ASSIGN_MUTATION" 2>/dev/null || echo "")
                    
                    if [ -n "$ASSIGN_RESPONSE" ]; then
                      ASSIGNEES=$(echo "$ASSIGN_RESPONSE" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
                      echo "‚úÖ Successfully assigned consolidated issue #$CONSOLIDATED_NUMBER to Copilot"
                      echo "Assignees: $ASSIGNEES"
                    else
                      echo "‚ö†Ô∏è Failed to assign consolidated issue to Copilot (mutation failed)"
                    fi
                  else
                    echo "‚ö†Ô∏è Failed to get consolidated issue GraphQL ID"
                  fi
                else
                  echo "‚ö†Ô∏è Copilot SWE agent not found in repository suggested actors"
                  echo "Note: GitHub Copilot may not be enabled for this repository"
                fi
              else
                echo "‚ö†Ô∏è Failed to query repository suggested actors"
              fi
              
              # Add comprehensive Copilot comment
              printf "## ü§ñ GitHub Copilot Comprehensive Fix Request\n\n" > consolidated_comment.md
              printf "@github-copilot please analyze and fix the %s security vulnerabilities detected in this scan:\n\n" "$VULN_COUNT" >> consolidated_comment.md
              printf "### üéØ Primary Objectives:\n" >> consolidated_comment.md
              printf "1. **Immediate Fixes:** Provide specific npm/yarn commands for each vulnerability\n" >> consolidated_comment.md
              printf "2. **Risk Assessment:** Evaluate the security impact of each vulnerability\n" >> consolidated_comment.md
              printf "3. **Compatibility Analysis:** Check for breaking changes in proposed fixes\n" >> consolidated_comment.md
              printf "4. **Testing Strategy:** Recommend verification steps for each fix\n" >> consolidated_comment.md
              printf "5. **Alternative Solutions:** Suggest alternatives if direct updates aren't safe\n\n" >> consolidated_comment.md
              printf "### üìã Required Actions:\n" >> consolidated_comment.md
              printf "- Review each vulnerability listed in the report above\n" >> consolidated_comment.md
              printf "- Provide specific fix commands (npm update, npm install, etc.)\n" >> consolidated_comment.md
              printf "- Identify any dependencies that require manual intervention\n" >> consolidated_comment.md
              printf "- Suggest batch processing approach for multiple fixes\n" >> consolidated_comment.md
              printf "- Recommend testing procedures before production deployment\n\n" >> consolidated_comment.md
              printf "### üîß Expected Response Format:\n" >> consolidated_comment.md
              printf "\`\`\`bash\n" >> consolidated_comment.md
              printf "# High Priority Fixes (Critical/High severity)\n" >> consolidated_comment.md
              printf "npm audit fix --force\n" >> consolidated_comment.md
              printf "npm update package-name@version\n\n" >> consolidated_comment.md
              printf "# Individual package fixes\n" >> consolidated_comment.md
              printf "npm install package-name@fixed-version\n" >> consolidated_comment.md
              printf "\`\`\`\n\n" >> consolidated_comment.md
              if [ "$VULN_COUNT" -gt 5 ]; then
                printf "### ‚ö° Priority Level: **CRITICAL**\n" >> consolidated_comment.md
              else
                printf "### ‚ö° Priority Level: **HIGH**\n" >> consolidated_comment.md
              fi
              printf "Please prioritize this security scan and provide actionable fix recommendations.\n\n" >> consolidated_comment.md
              printf "**Scan Context:**\n" >> consolidated_comment.md
              printf "- Repository: %s\n" "${{ github.repository }}" >> consolidated_comment.md
              printf "- Scan Date: %s\n" "$(date)" >> consolidated_comment.md
              printf "- Total Vulnerabilities: %s\n" "$VULN_COUNT" >> consolidated_comment.md
              printf "- Workflow: Automated Security Scan\n\n" >> consolidated_comment.md
              printf "*This issue was automatically created and assigned by the AI Security Scan workflow*\n" >> consolidated_comment.md
              
              # Add the comment
              if gh issue comment "$CONSOLIDATED_NUMBER" --body-file consolidated_comment.md 2>/dev/null; then
                echo "‚úÖ Added comprehensive Copilot comment to consolidated issue #$CONSOLIDATED_NUMBER"
              else
                echo "‚ö†Ô∏è Failed to add Copilot comment to consolidated issue #$CONSOLIDATED_NUMBER"
              fi
              
            else
              echo "‚ùå Failed to create consolidated vulnerability issue"
            fi
            
          else
            echo "No vulnerabilities found, skipping consolidated report creation"
          fi

      # Step 8: Upload issue creation artifacts
      - name: Upload issue artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-issues
          path: |
            vulnerability-issues.md
            vulnerability-data/

      # Step 9: Update step summary
      - name: Issue creation summary
        if: always()
        run: |
          VULN_COUNT=$(jq 'length' vulnerability-data/detailed-vulnerabilities.json 2>/dev/null || echo "0")
          
          echo "## üêõ GitHub Issues Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Issues Created:** $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "**Issue Creation Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f vulnerability-issues.md ]; then
            echo "### üìã Created Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat vulnerability-issues.md | tail -n +5 >> $GITHUB_STEP_SUMMARY || echo "No issue details available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ü§ñ GitHub Copilot Integration" >> $GITHUB_STEP_SUMMARY
          echo "Each vulnerability issue includes:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ **Automatic Assignment:** Issues assigned to GitHub Copilot SWE agent" >> $GITHUB_STEP_SUMMARY
          echo "- üéØ **Specific Fix Requests:** Detailed Copilot assistance comments" >> $GITHUB_STEP_SUMMARY
          echo "- üìã **Actionable Tasks:** Clear requirements for fix commands" >> $GITHUB_STEP_SUMMARY
          echo "- üîç **Vulnerability Analysis:** Comprehensive security context" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ **Priority Classification:** Critical/High priority labeling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Labels Applied:** \`security\`, \`vulnerability\`, \`ai-fix-requested\`, \`copilot-task\`, \`scheduled\`" >> $GITHUB_STEP_SUMMARY
          echo "**Priority Labels:** \`critical\`, \`high-priority\` (based on severity)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Master Tracking Issue" >> $GITHUB_STEP_SUMMARY
          echo "A comprehensive tracking issue has been created to monitor progress on all vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "This issue includes action items, AI assistance summary, and progress tracking." >> $GITHUB_STEP_SUMMARY
          echo "The tracking issue is also assigned to GitHub Copilot for coordination." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Consolidated Report" >> $GITHUB_STEP_SUMMARY
          echo "A consolidated vulnerability report issue has been created with:" >> $GITHUB_STEP_SUMMARY
          echo "- Complete vulnerability analysis for Copilot review" >> $GITHUB_STEP_SUMMARY
          echo "- Automatic assignment to GitHub Copilot SWE agent" >> $GITHUB_STEP_SUMMARY
          echo "- Comprehensive fix request with specific objectives" >> $GITHUB_STEP_SUMMARY
          echo "- Expected response format and priority classification" >> $GITHUB_STEP_SUMMARY
